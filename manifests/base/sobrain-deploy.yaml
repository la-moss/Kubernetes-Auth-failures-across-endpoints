apiVersion: apps/v1
kind: Deployment
metadata:
  name: sobrain
  namespace: incident-lab
  labels: { app: sobrain }
spec:
  replicas: 1
  selector:
    matchLabels: { app: sobrain }
  template:
    metadata:
      labels: { app: sobrain }
    spec:
      containers:
        - name: sobrain
          image: python:3.11-alpine
          env:
            - name: DELAY_MS
              value: "800"
          command: ["python","-u","-c"]
          args:
            - |
              import os, time
              from http.server import BaseHTTPRequestHandler, HTTPServer
              delay = int(os.getenv("DELAY_MS","0"))/1000.0
              class H(BaseHTTPRequestHandler):
                  def do_GET(self):
                      if self.path == "/healthz":
                          self.send_response(200)
                          self.end_headers()
                          self.wfile.write(b"ok")
                          return
                      time.sleep(delay)
                      self.send_response(200)
                      self.end_headers()
                      self.wfile.write(b"ok")
                  def log_message(self, fmt, *args): pass
              HTTPServer(("0.0.0.0", 8080), H).serve_forever()
          ports:
            - containerPort: 8080
          readinessProbe:
            httpGet: { path: "/healthz", port: 8080 }
            initialDelaySeconds: 2
            periodSeconds: 3
